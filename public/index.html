<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gesti√≥n de Pacientes</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f7fa;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      padding: 20px;
    }
    button {
      padding: 10px 20px;
      background-color: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table th, table td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    table th {
      background-color: #f4f4f4;
    }
    .actions {
      display: flex;
      gap: 10px;
    }
    .btn-action {
      cursor: pointer;
      color: #007BFF;
      font-size: 18px;
    }
    .btn-action:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>Gesti√≥n de Pacientes</h1>
  <button id="btn-agregar">Agregar Paciente</button>
  <table id="tabla-pacientes">
    <thead>
      <tr>
        <th>Id</th>
        <th>Nombre</th>
        <th>Apellido</th>
        <th>Tel√©fono</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Seguro</th>
        <th>√öltima Visita</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal para agregar o editar paciente -->
  <div id="modal" style="display:none;">
    <div style="background-color:white; padding:20px; border-radius:5px; width:300px; margin:auto;">
      <h2 id="modal-titulo">Agregar Paciente</h2>
      <form id="form-paciente">
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" required>
        <label for="apellido">Apellido:</label>
        <input type="text" id="apellido">
        <label for="telefono">Tel√©fono:</label>
        <input type="text" id="telefono">
        <label for="correo">Correo:</label>
        <input type="email" id="correo">
        <label for="edad">Edad:</label>
        <input type="number" id="edad">
        <label for="seguro">N√∫mero de Seguro:</label>
        <input type="text" id="seguro">
        <label for="ultima_visita">√öltima Visita:</label>
        <input type="date" id="ultima_visita">

        <!-- Campos del historial m√©dico -->
        <label for="condiciones_medicas">Condiciones M√©dicas:</label>
        <textarea id="condiciones_medicas"></textarea>
        <label for="medicamentos">Medicamentos:</label>
        <textarea id="medicamentos"></textarea>
        <label for="detalles_alergias">Detalles Alergias:</label>
        <textarea id="detalles_alergias"></textarea>
        <label for="gravedad_alergias">Gravedad de Alergias:</label>
        <input type="text" id="gravedad_alergias">
        <label for="alergias">Alergias:</label>
        <textarea id="alergias"></textarea>

        <button type="submit">Guardar</button>
      </form>
      <button onclick="cerrarModal()">Cerrar</button>
    </div>
  </div>

  <script>
    const modal = document.getElementById('modal');
    const form = document.getElementById('form-paciente');
    const tablaPacientes = document.getElementById('tabla-pacientes').getElementsByTagName('tbody')[0];
    let pacientes = [];
    let editIndex = -1;

    // Funci√≥n para obtener pacientes de la base de datos
    async function obtenerPacientes() {
      try {
        const response = await fetch('/api/pacientes');
        pacientes = await response.json();
        actualizarTabla();
      } catch (error) {
        console.error('Error al obtener los pacientes:', error);
      }
    }

    // Llamar a obtenerPacientes al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', obtenerPacientes);

    // Funci√≥n para abrir el modal
    document.getElementById('btn-agregar').onclick = () => abrirModal();

    function abrirModal(paciente = null) {
      modal.style.display = 'block';
      if (paciente) {
        document.getElementById('modal-titulo').innerText = 'Editar Paciente';
        document.getElementById('nombre').value = paciente.nombre;
        document.getElementById('apellido').value = paciente.apellido;
        document.getElementById('telefono').value = paciente.numero_telefono;
        document.getElementById('correo').value = paciente.correo_electronico;
        document.getElementById('edad').value = paciente.edad;
        document.getElementById('seguro').value = paciente.numero_seguro;
        document.getElementById('ultima_visita').value = paciente.ultima_visita;
        
        // Campos del historial m√©dico
        document.getElementById('condiciones_medicas').value = paciente.historial_medico.condiciones_medicas || '';
        document.getElementById('medicamentos').value = paciente.historial_medico.medicamentos || '';
        document.getElementById('detalles_alergias').value = paciente.historial_medico.detalles_alergias || '';
        document.getElementById('gravedad_alergias').value = paciente.historial_medico.gravedad_alergias || '';
        document.getElementById('alergias').value = paciente.historial_medico.alergias || '';

        editIndex = pacientes.findIndex(p => p._id === paciente._id);
      } else {
        form.reset();
        editIndex = -1;
        document.getElementById('modal-titulo').innerText = 'Agregar Paciente';
      }
    }

    // Funci√≥n para cerrar el modal
    function cerrarModal() {
      modal.style.display = 'none';
    }

    // Funci√≥n para manejar el formulario de agregar/editar paciente
    form.onsubmit = async (e) => {
      e.preventDefault();

      // Obtener los valores de los campos
      const paciente = {
        nombre: form.nombre.value,
        apellido: form.apellido.value,
        numero_telefono: form.telefono.value,
        correo_electronico: form.correo.value,
        edad: form.edad.value,
        numero_seguro: form.seguro.value,
        ultima_visita: form.ultima_visita.value,
        historial_medico: {
          condiciones_medicas: form.condiciones_medicas.value,
          medicamentos: form.medicamentos.value,
          detalles_alergias: form.detalles_alergias.value,
          gravedad_alergias: form.gravedad_alergias.value,
          alergias: form.alergias.value
        }
      };

      try {
        let response;
        if (editIndex !== -1) {
          response = await fetch(`/api/pacientes/${pacientes[editIndex]._id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paciente),
          });
        } else {
          response = await fetch('/api/pacientes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(paciente),
          });
        }

        const data = await response.json();
        if (response.ok) {
          alert('Paciente guardado con √©xito');
          obtenerPacientes();
          cerrarModal();
        } else {
          alert('Error al guardar el paciente');
        }
      } catch (error) {
        console.error('Error al guardar el paciente:', error);
      }
    };

    // Funci√≥n para actualizar la tabla
    function actualizarTabla() {
      tablaPacientes.innerHTML = '';
      pacientes.forEach(paciente => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${paciente._id}</td>
          <td>${paciente.nombre}</td>
          <td>${paciente.apellido}</td>
          <td>${paciente.numero_telefono}</td>
          <td>${paciente.correo_electronico}</td>
          <td>${paciente.edad}</td>
          <td>${paciente.numero_seguro}</td>
          <td>${paciente.ultima_visita}</td>
          <td class="actions">
            <span class="btn-action" onclick="verDetalles('${paciente._id}')">üëÅÔ∏è</span>
            <span class="btn-action" onclick="editarPaciente('${paciente._id}')">‚úèÔ∏è</span>
            <span class="btn-action" onclick="eliminarPaciente('${paciente._id}')">üóëÔ∏è</span>
          </td>
        `;
        tablaPacientes.appendChild(tr);
      });
    }

    // Funci√≥n para ver detalles de un paciente
    function verDetalles(id) {
      const paciente = pacientes.find(p => p._id === id);
      alert(`Detalles del paciente: ${JSON.stringify(paciente, null, 2)}`);
    }

    // Funci√≥n para editar un paciente
    function editarPaciente(id) {
      const paciente = pacientes.find(p => p._id === id);
      abrirModal(paciente);
    }

    // Funci√≥n para eliminar un paciente
    async function eliminarPaciente(id) {
      if (confirm('¬øEst√°s seguro de eliminar este paciente?')) {
        try {
          await fetch(`/api/pacientes/${id}`, { method: 'DELETE' });
          alert('Paciente eliminado');
          obtenerPacientes();
        } catch (error) {
          alert('Error al eliminar el paciente');
          console.error(error);
        }
      }
    }
  </script>
</body>
</html>